<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Absensi SMK Bina Mandiri</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: "Poppins", sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        
        .bg-login { 
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                        url('a62068ec-917a-4201-ba97-d5dc828be7d4.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 700; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container">
        <!-- VIEW 1: PORTAL UTAMA -->
        <div id="view-portal" class="bg-login fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="glass rounded-3xl shadow-2xl w-full max-w-md p-8 text-center fade-in">
                <img src="logo.png" alt="Logo SMK Bina Mandiri" class="h-28 mx-auto mb-6 drop-shadow-lg">
                <h1 class="text-2xl font-bold text-gray-800">SMK Bina Mandiri</h1>
                <p class="text-gray-500 text-sm mb-8">Sistem Presensi Digital</p>
                
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="navigateTo('attendance')" class="flex items-center justify-between bg-blue-700 text-white p-5 rounded-2xl font-bold hover:bg-blue-800 transition shadow-lg group">
                        <span class="text-lg">Masuk Absensi Siswa</span>
                        <svg class="h-6 w-6 group-hover:translate-x-2 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M13 7l5 5m0 0l-5 5m5-5H6" stroke-width="2"/></svg>
                    </button>
                    <button onclick="navigateTo('login')" class="flex items-center justify-between bg-white text-gray-700 border-2 border-gray-100 p-5 rounded-2xl font-bold hover:bg-gray-50 transition shadow-sm">
                        <span class="text-lg text-blue-700">Login Administrator</span>
                        <svg class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: HALALMAN ABSENSI SISWA -->
        <div id="view-attendance" class="bg-login fixed inset-0 z-40 hidden flex items-center justify-center p-4">
            <div class="glass rounded-3xl shadow-2xl w-full max-w-lg p-8 fade-in relative text-center">
                <button onclick="navigateTo('portal')" class="absolute top-6 left-6 text-gray-400 hover:text-blue-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                </button>
                
                <img src="logo.png" alt="Logo" class="h-20 mx-auto mb-4">
                <h2 class="text-xl font-bold text-gray-800">Presensi Mandiri Siswa</h2>
                <p id="live-time-student" class="text-blue-600 font-bold text-2xl mt-2 mb-8">00:00:00</p>

                <div id="attendance-form" class="space-y-5">
                    <div class="text-left">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Pilih Nama Lengkap</label>
                        <select id="student-select" class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition appearance-none cursor-pointer">
                            <option value="">-- Cari Nama Anda --</option>
                        </select>
                    </div>

                    <button onclick="submitAttendance()" class="w-full bg-blue-700 text-white py-5 rounded-2xl font-bold shadow-xl hover:bg-blue-800 transition transform active:scale-95 text-lg">KONFIRMASI ABSENSI</button>
                </div>
                
                <div id="attendance-success" class="hidden py-10">
                    <div class="bg-green-100 text-green-700 p-6 rounded-2xl border border-green-200">
                        <svg class="h-12 w-12 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                        <p class="font-bold text-lg">Absensi Berhasil!</p>
                        <p class="text-sm">Anda akan dialihkan kembali dalam 3 detik...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: LOGIN ADMIN -->
        <div id="view-login" class="bg-login fixed inset-0 z-40 hidden flex items-center justify-center p-4">
            <div class="glass rounded-3xl shadow-2xl w-full max-w-md p-10 text-center fade-in relative">
                <button onclick="navigateTo('portal')" class="absolute top-6 left-6 text-gray-400">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                </button>
                <img src="logo.png" alt="Logo" class="h-20 mx-auto mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-8">Login Administrator</h2>
                
                <form id="login-form" class="space-y-4 text-left">
                    <input type="password" id="admin-password" placeholder="Masukkan Password Admin" class="w-full px-5 py-4 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                    <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-black transition active:scale-95">MASUK PANEL KONTROL</button>
                </form>
                <p id="login-error" class="text-red-500 text-xs mt-4 hidden font-bold italic">Password admin salah!</p>
            </div>
        </div>

        <!-- VIEW 4: DASHBOARD ADMIN -->
        <div id="view-admin" class="hidden min-h-screen">
            <header class="bg-blue-900 text-white p-6 shadow-xl sticky top-0 z-50">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <img src="logo.png" class="h-10 bg-white p-1 rounded-lg">
                        <div>
                            <h1 class="font-bold text-lg leading-none">Admin SMK Bina Mandiri</h1>
                            <p class="text-[10px] uppercase font-bold tracking-widest opacity-60">Dashboard Kendali</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right">
                            <div id="live-time-admin" class="text-xl font-bold tabular-nums">00:00:00</div>
                            <div id="live-date-admin" class="text-[9px] opacity-70 uppercase font-bold tracking-widest">Memuat...</div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 p-3 rounded-xl transition shadow-lg">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
            </header>

            <main class="container mx-auto p-4 md:p-8">
                <!-- Nav Tabs -->
                <div class="flex gap-6 border-b mb-8 overflow-x-auto">
                    <button id="tab-btn-today" onclick="switchTab('today')" class="tab-active pb-2 text-sm font-bold transition">Absensi Hari Ini</button>
                    <button id="tab-btn-history" onclick="switchTab('history')" class="text-gray-400 pb-2 text-sm font-bold transition hover:text-blue-600">Riwayat & Arsip</button>
                    <button id="tab-btn-qris" onclick="switchTab('qris')" class="text-gray-400 pb-2 text-sm font-bold transition hover:text-blue-600">QRIS Kehadiran</button>
                </div>

                <!-- Tab: Today -->
                <div id="tab-today" class="tab-content">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-green-500">
                            <p class="text-[10px] font-bold text-gray-400 uppercase">Hadir Tepat</p>
                            <h3 id="stat-present" class="text-4xl font-black text-gray-800">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-red-500">
                            <p class="text-[10px] font-bold text-gray-400 uppercase">Terlambat</p>
                            <h3 id="stat-late" class="text-4xl font-black text-gray-800">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-gray-200">
                            <p class="text-[10px] font-bold text-gray-400 uppercase">Belum Absen</p>
                            <h3 id="stat-missing" class="text-4xl font-black text-gray-800">28</h3>
                        </div>
                        <div class="bg-blue-600 p-6 rounded-3xl shadow-sm text-white">
                            <p class="text-blue-200 text-[10px] font-bold uppercase">Total Siswa</p>
                            <h3 class="text-4xl font-black">28</h3>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
                        <div class="p-6 bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4 border-b">
                            <h2 class="font-bold text-gray-800">Pemantauan Presensi</h2>
                            <div class="flex gap-2">
                                <button onclick="exportExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-700 transition">Ekspor Excel</button>
                                <button onclick="exportPDF()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-rose-700 transition">Ekspor PDF</button>
                                <button onclick="manualReset()" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition">Reset Manual Hari Ini</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                                    <tr>
                                        <th class="px-6 py-4">No</th>
                                        <th class="px-6 py-4">Nama Siswa</th>
                                        <th class="px-6 py-4">L/P</th>
                                        <th class="px-6 py-4">Waktu</th>
                                        <th class="px-6 py-4">Keterangan</th>
                                        <th class="px-6 py-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-attendance-body" class="divide-y divide-gray-100 text-sm">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: History -->
                <div id="tab-history" class="tab-content hidden">
                    <div class="bg-white rounded-3xl shadow-sm p-8">
                        <h2 class="font-bold text-xl text-gray-800 mb-8">Arsip Riwayat Harian</h2>
                        <div id="history-list" class="space-y-4">
                            <div class="text-center py-20 text-gray-400 italic">Belum ada riwayat tersimpan. Riwayat disimpan otomatis setiap jam 15:00.</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: QRIS -->
                <div id="tab-qris" class="tab-content hidden">
                    <div class="bg-white rounded-3xl shadow-sm p-10 max-w-xl mx-auto text-center border-2 border-blue-50">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">QRIS Presensi Massal</h2>
                        <p id="qris-date-label" class="text-sm font-bold text-blue-500 uppercase tracking-widest mb-10">Memuat Tanggal...</p>
                        
                        <div class="bg-white p-6 rounded-3xl shadow-inner border border-gray-50 mb-10 inline-block">
                            <img src="download.jpg" alt="QRIS Absensi" class="h-64 mx-auto rounded-lg shadow-md">
                        </div>
                        
                        <p class="text-sm text-gray-500 italic max-w-xs mx-auto">Tampilkan gambar ini kepada siswa untuk proses absensi mandiri di halaman depan.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // DATA SISWA MASTER (28 Siswa)
        const MASTER_STUDENTS = [
            ["Anwar Heriyansyah", "Laki Laki"], ["Dila Mey Siska", "Perempuan"], ["Muhammad Oki Cesa", "Laki Laki"],
            ["Novitasari", "Perempuan"], ["Rofi Michael Yusuf", "Laki Laki"], ["Zaiyan Izhan Idlan", "Laki Laki"],
            ["Fina Ramadhani", "Perempuan"], ["M. Fahri Novian", "Laki Laki"], ["Andika", "Laki Laki"],
            ["Dafa Nofa Erlangga", "Laki Laki"], ["Fahri Maulana", "Laki Laki"], ["Faujiah Sulaesih", "Perempuan"],
            ["Kenzie Raditya Osas", "Laki Laki"], ["Siti Amelia", "Perempuan"], ["Tesa Lonika Saufani", "Perempuan"],
            ["Theresia Yunita Jadi", "Perempuan"], ["Fita Bunga", "Perempuan"], ["Rivky Jesen P", "Laki Laki"],
            ["Alvin Putra Pratama", "Laki Laki"], ["Arya Dimas Pratama", "Laki Laki"], ["Cornelius Rowen N", "Laki Laki"],
            ["Devi Afriyanti", "Perempuan"], ["Elti Julianti Anthoneta B", "Perempuan"], ["Fitria Sari Gozali", "Perempuan"],
            ["Leni Nur'aini", "Perempuan"], ["Muhammad Raihan", "Laki Laki"], ["Parasha Hapizah Asipa", "Perempuan"],
            ["Raihan Ardiansyah", "Laki Laki"]
        ];

        const CONFIG = {
            adminPass: "admin123",
            resetTime: "15:00:00",
            entryStart: "07:30",
            lateTolerance: 10, // Menit (Sampai 07:40 Oke, 07:41 Telat)
            homeMonThu: "14:05",
            homeFri: "11:00"
        };

        let state = {
            view: 'portal',
            lastResetDate: '',
            todayData: [],
            history: []
        };

        // INITIALIZATION
        function init() {
            const saved = localStorage.getItem('smk_bm_db_v3');
            if (saved) {
                state = JSON.parse(saved);
            } else {
                initNewDay();
            }

            checkResetTime();
            updateClocks();
            setInterval(updateClocks, 1000);
            renderView();
            populateStudentSelect();
        }

        function save() {
            localStorage.setItem('smk_bm_db_v3', JSON.stringify(state));
        }

        function initNewDay() {
            state.todayData = MASTER_STUDENTS.map((s, i) => ({
                id: i, name: s[0], gender: s[1], status: '', time: null, isLate: false
            }));
            state.lastResetDate = new Date().toDateString();
            save();
        }

        // NAVIGATION
        function navigateTo(target) {
            state.view = target;
            renderView();
        }

        function renderView() {
            const views = ['portal', 'attendance', 'login', 'admin'];
            views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            
            const current = document.getElementById(`view-${state.view}`);
            if (current) current.classList.remove('hidden');

            if (state.view === 'attendance') {
                document.getElementById('attendance-form').classList.remove('hidden');
                document.getElementById('attendance-success').classList.add('hidden');
                populateStudentSelect();
            }
            
            if (state.view === 'admin') renderAdmin();
        }

        // TIME & RESET LOGIC
        function updateClocks() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour12: false });
            const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            if (document.getElementById('live-time-student')) document.getElementById('live-time-student').textContent = timeStr;
            if (document.getElementById('live-time-admin')) document.getElementById('live-time-admin').textContent = timeStr;
            if (document.getElementById('live-date-admin')) document.getElementById('live-date-admin').textContent = dateStr;
            if (document.getElementById('qris-date-label')) document.getElementById('qris-date-label').textContent = dateStr;

            if (timeStr === CONFIG.resetTime) autoArchiveAndReset();
        }

        function checkResetTime() {
            const today = new Date().toDateString();
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour12: false });

            // Jika hari berganti ATAU sudah lewat jam 15:00 hari ini tapi belum direset
            if (state.lastResetDate !== today || (timeStr >= CONFIG.resetTime && state.lastResetDate === today)) {
                autoArchiveAndReset();
            }
        }

        function autoArchiveAndReset() {
            const today = new Date().toDateString();
            
            // Masukkan ke riwayat jika ada data
            if (state.todayData.some(s => s.status)) {
                state.history.unshift({
                    date: today + (new Date().getHours() >= 15 ? ' (15:00 Reset)' : ''),
                    data: JSON.parse(JSON.stringify(state.todayData))
                });
                if (state.history.length > 30) state.history.pop();
            }

            initNewDay();
            state.lastResetDate = today + "_reset"; // Flag agar tidak looping reset dalam satu detik
            save();
            if (state.view === 'admin') renderAdmin();
        }

        // STUDENT ATTENDANCE
        function populateStudentSelect() {
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">-- Cari Nama Anda --</option>';
            
            // Hanya tampilkan siswa yang BELUM absen
            const available = [...state.todayData].sort((a,b) => a.name.localeCompare(b.name));
            available.forEach(s => {
                if (!s.status) {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                }
            });
        }

        function submitAttendance() {
            const studentId = document.getElementById('student-select').value;
            if (!studentId) {
                alert("Silakan pilih nama Anda terlebih dahulu.");
                return;
            }

            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            // Logika Terlambat (07:30 + 10 menit = 07:40)
            const [h, m] = timeStr.split(':').map(Number);
            const isLate = (h > 7) || (h === 7 && m > (30 + CONFIG.lateTolerance));

            const student = state.todayData.find(s => s.id == studentId);
            student.status = 'hadir';
            student.time = timeStr;
            student.isLate = isLate;

            save();

            document.getElementById('attendance-form').classList.add('hidden');
            document.getElementById('attendance-success').classList.remove('hidden');

            // Keluar otomatis setelah 3 detik
            setTimeout(() => {
                navigateTo('portal');
            }, 3000);
        }

        // ADMIN LOGIC
        document.getElementById('login-form').onsubmit = function(e) {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            if (pass === CONFIG.adminPass) {
                navigateTo('admin');
                document.getElementById('admin-password').value = "";
            } else {
                const err = document.getElementById('login-error');
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 3000);
            }
        };

        function logout() { navigateTo('portal'); }

        function switchTab(target) {
            ['today', 'history', 'qris'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-btn-${t}`).classList.add('text-gray-400');
            });
            document.getElementById(`tab-${target}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${target}`).classList.add('tab-active');
            document.getElementById(`tab-btn-${target}`).classList.remove('text-gray-400');
        }

        function renderAdmin() {
            const body = document.getElementById('table-attendance-body');
            body.innerHTML = '';
            
            let present = 0, late = 0;
            state.todayData.forEach((s, i) => {
                if (s.status) {
                    present++;
                    if (s.isLate) late++;
                }

                const row = document.createElement('tr');
                const statusTag = s.status 
                    ? `<span class="px-3 py-1 rounded-full font-bold text-[10px] ${s.isLate ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${s.isLate ? 'TERLAMBAT' : 'HADIR'}</span>`
                    : `<span class="px-3 py-1 rounded-full font-bold text-[10px] bg-gray-100 text-gray-400">ALPA</span>`;

                row.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-400">${i + 1}</td>
                    <td class="px-6 py-4 font-bold text-gray-800">${s.name}</td>
                    <td class="px-6 py-4 text-gray-500 font-medium">${s.gender === 'Laki Laki' ? 'L' : 'P'}</td>
                    <td class="px-6 py-4 font-bold text-blue-800">${s.time || '--:--'}</td>
                    <td class="px-6 py-4">${statusTag}</td>
                    <td class="px-6 py-4 text-center">
                        ${s.status ? `<button onclick="resetSiswa(${s.id})" class="text-red-400 hover:text-red-600 p-2"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>` : ''}
                    </td>
                `;
                body.appendChild(row);
            });

            document.getElementById('stat-present').textContent = (present - late);
            document.getElementById('stat-late').textContent = late;
            document.getElementById('stat-missing').textContent = (28 - present);

            renderHistory();
        }

        function resetSiswa(id) {
            if (confirm("Hapus absen siswa ini?")) {
                const s = state.todayData.find(x => x.id == id);
                s.status = ''; s.time = null; s.isLate = false;
                save(); renderAdmin();
            }
        }

        function manualReset() {
            if (confirm("Bersihkan seluruh absensi hari ini?")) {
                initNewDay(); renderAdmin();
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if (state.history.length === 0) return;
            
            container.innerHTML = '';
            state.history.forEach((h, idx) => {
                const count = h.data.filter(s => s.status).length;
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-6 bg-gray-50 rounded-2xl border border-gray-100 group hover:border-blue-200 transition";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="h-10 w-10 bg-white rounded-xl flex items-center justify-center font-bold text-blue-900 shadow-sm">${idx + 1}</div>
                        <div>
                            <p class="font-bold text-gray-800">${h.date}</p>
                            <p class="text-xs text-gray-400 font-medium">${count} Siswa Hadir dari 28</p>
                        </div>
                    </div>
                    <button onclick="downloadHistory(${idx})" class="text-[10px] bg-blue-100 text-blue-700 px-4 py-2 rounded-xl font-bold uppercase hover:bg-blue-600 hover:text-white transition">Unduh PDF</button>
                `;
                container.appendChild(div);
            });
        }

        // EXPORTS
        function exportExcel() {
            const data = state.todayData.map((s, i) => ({
                'No': i + 1, 'Nama': s.name, 'Gender': s.gender, 'Waktu': s.time || '-', 'Status': s.status ? (s.isLate ? 'TELAT' : 'HADIR') : 'ALPA'
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi");
            XLSX.writeFile(wb, `Laporan_BM_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Laporan Presensi SMK Bina Mandiri", 105, 15, { align: 'center' });
            const rows = state.todayData.map((s, i) => [i+1, s.name, s.gender === 'Laki Laki' ? 'L' : 'P', s.time || '-', s.status ? (s.isLate ? 'TELAT' : 'HADIR') : 'ALPA']);
            doc.autoTable({ head: [['No', 'Nama', 'L/P', 'Jam', 'Ket']], body: rows, startY: 25 });
            doc.save(`Laporan_BM_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        function downloadHistory(idx) {
            const h = state.history[idx];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Arsip Presensi SMK Bina Mandiri`, 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Tanggal: ${h.date}`, 105, 22, { align: 'center' });
            const rows = h.data.map((s, i) => [i+1, s.name, s.gender === 'Laki Laki' ? 'L' : 'P', s.time || '-', s.status ? (s.isLate ? 'TELAT' : 'HADIR') : 'ALPA']);
            doc.autoTable({ head: [['No', 'Nama', 'L/P', 'Jam', 'Ket']], body: rows, startY: 30 });
            doc.save(`Arsip_BM_${h.date.replace(/ /g, '_')}.pdf`);
        }

        init();
    </script>
</body>
</html>