<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>E-Presensi SMK Bina Mandiri</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <!-- Export Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: "Poppins", sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .bg-cover-custom { 
            /* Background Image Update: unnamed.jpg */
            background: linear-gradient(rgba(0, 50, 100, 0.85), rgba(0, 20, 50, 0.95)), url('unnamed.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .tab-btn.active { background-color: #1e40af; color: white; font-weight: 700; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner */
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #1e40af; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { padding: 12px 24px; border-radius: 12px; color: white; margin-bottom: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- TOAST NOTIFICATION AREA -->
    <div id="toast-container"></div>

    <!-- VIEW: LOADING SCREEN -->
    <div id="view-loading" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="h-12 w-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold text-gray-400 tracking-widest animate-pulse">MENGHUBUNGKAN KE SERVER...</p>
    </div>

    <!-- VIEW: PRESENSI SISWA -->
    <div id="view-siswa" class="hidden min-h-screen bg-cover-custom flex flex-col items-center justify-center p-4">
        <div class="glass-panel rounded-[2rem] w-full max-w-lg p-8 text-center fade-in relative">
            
            <!-- Connection Status Indicator -->
            <div id="connection-status" class="absolute top-4 right-4 h-3 w-3 rounded-full bg-gray-300" title="Status Koneksi"></div>

            <!-- Logo Update: logo.png -->
            <img src="logo.png" alt="Logo SMK" class="h-24 mx-auto mb-4 drop-shadow-xl hover:scale-105 transition duration-300">
            
            <h1 class="text-2xl font-black text-gray-800 tracking-tight">E-Presensi SMK</h1>
            <p class="text-blue-600 font-bold text-[10px] mb-8 uppercase tracking-[0.2em]">Sistem Kehadiran Realtime</p>

            <!-- Clock Card (Dipisah agar tetap muncul saat sudah absen) -->
            <div class="bg-gradient-to-r from-blue-50 to-white p-5 rounded-2xl border border-blue-100 flex justify-between items-center shadow-sm mb-4">
                <div class="text-left">
                    <p class="text-[9px] font-bold text-blue-400 uppercase tracking-wider">Waktu Server</p>
                    <h2 id="clock-display" class="text-3xl font-black text-slate-800 tabular-nums">00:00:00</h2>
                </div>
                <button onclick="router('admin-login')" class="h-10 w-10 bg-white rounded-full flex items-center justify-center shadow-sm hover:bg-blue-50 text-gray-400 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </button>
            </div>

            <!-- Status Badge -->
            <div id="status-info" class="hidden text-[10px] font-bold text-center py-2.5 px-4 rounded-xl border border-dashed mb-4">
                <!-- Status dynamic text -->
            </div>

            <div id="form-container" class="space-y-4 text-left">
                <!-- Input Form -->
                <div class="pt-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Identitas Siswa</label>
                    <div class="relative">
                        <select id="input-nama" class="w-full p-4 pl-5 bg-white border-2 border-gray-100 rounded-2xl font-bold text-sm outline-none focus:border-blue-500 appearance-none transition shadow-sm text-gray-700">
                            <option value="">-- Pilih Nama Anda --</option>
                        </select>
                        <div class="absolute right-4 top-4 text-gray-400 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                </div>

                <button onclick="kirimAbsensi()" id="btn-absen" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-black hover:scale-[1.02] active:scale-95 transition-all flex justify-center items-center gap-2 mt-4">
                    KIRIM KEHADIRAN
                </button>
            </div>

            <!-- Success State -->
            <div id="success-message" class="hidden py-8 flex flex-col items-center animate-bounce-in">
                <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-6 shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h2 class="text-2xl font-black text-gray-800">Berhasil!</h2>
                <p class="text-gray-500 text-xs mt-2 font-medium">Data kehadiran tersimpan di server.</p>
                <!-- Tombol Absen Lagi DIHAPUS agar 1x saja -->
                <div class="mt-8 px-6 py-3 bg-gray-100 rounded-xl text-[10px] text-gray-400 font-mono">
                    Sesi Anda telah berakhir.
                </div>
            </div>
        </div>
        <p class="text-white/40 text-[10px] mt-6 font-mono">v2.5 Stable â€¢ One-Time Entry</p>
    </div>

    <!-- VIEW: ADMIN LOGIN -->
    <div id="view-admin-login" class="hidden min-h-screen bg-white flex items-center justify-center p-4">
        <div class="w-full max-w-md p-8 text-center fade-in">
            <button onclick="router('siswa')" class="mb-8 flex items-center text-gray-400 hover:text-gray-800 text-xs font-bold uppercase transition gap-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Kembali
            </button>
            <h2 class="text-2xl font-black text-gray-900 mb-2">Panel Admin</h2>
            <p class="text-gray-400 text-xs mb-8">Masukkan kode keamanan untuk akses dashboard.</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="password" id="admin-password" placeholder="Masukan Code" class="w-full px-6 py-4 text-center text-xl font-black tracking-widest border-2 border-gray-100 rounded-2xl outline-none focus:border-blue-600 focus:ring-4 focus:ring-blue-50 transition" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition">MASUK</button>
            </form>
        </div>
    </div>

    <!-- VIEW: ADMIN DASHBOARD -->
    <div id="view-admin-dashboard" class="hidden min-h-screen bg-gray-50 pb-20">
        <header class="bg-white border-b sticky top-0 z-50 px-6 h-16 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <!-- Logo Update: logo.png (Small) -->
                <img src="logo.png" alt="Logo BM" class="h-8 w-auto object-contain">
                <div>
                    <h1 class="text-xs font-black text-gray-800 uppercase tracking-tight">Dashboard Admin</h1>
                    <p id="server-status-text" class="text-[9px] font-bold text-gray-400 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> ONLINE</p>
                </div>
            </div>
            <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </header>

        <main class="max-w-5xl mx-auto px-4 py-6">
            <!-- Tabs -->
            <div class="flex p-1 bg-white rounded-xl shadow-sm mb-6 border border-gray-100 overflow-hidden">
                <button onclick="switchTab('today')" id="tab-today" class="tab-btn active flex-1 py-3 text-xs font-bold rounded-lg transition">HARI INI</button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs font-bold rounded-lg transition text-gray-400 hover:bg-gray-50">RIWAYAT</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn flex-1 py-3 text-xs font-bold rounded-lg transition text-gray-400 hover:bg-gray-50">PENGATURAN</button>
            </div>

            <!-- TAB CONTENT: TODAY -->
            <div id="content-today" class="fade-in">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:scale-110 transition"><svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/></svg></div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Hadir</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="stat-hadir">0</h3>
                        <div class="w-full h-1 bg-green-100 mt-3 rounded-full overflow-hidden"><div class="h-full bg-green-500 w-full"></div></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Terlambat</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="stat-telat">0</h3>
                        <div class="w-full h-1 bg-red-100 mt-3 rounded-full overflow-hidden"><div class="h-full bg-red-500 w-full"></div></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Izin/Sakit</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="stat-izin">0</h3>
                        <div class="w-full h-1 bg-blue-100 mt-3 rounded-full overflow-hidden"><div class="h-full bg-blue-500 w-full"></div></div>
                    </div>
                    <div class="bg-gray-800 text-white p-5 rounded-2xl shadow-sm border border-gray-700 relative overflow-hidden group">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Alpha</p>
                        <h3 class="text-3xl font-black mt-1" id="stat-alpha">0</h3>
                        <div class="w-full h-1 bg-gray-600 mt-3 rounded-full overflow-hidden"><div class="h-full bg-white w-full"></div></div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
                    <div class="p-6 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wider">Monitor Kehadiran</h2>
                        <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-[10px] font-bold shadow-sm transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            UNDUH EXCEL
                        </button>
                    </div>
                    <div id="siswa-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-0 divide-y md:divide-y-0 md:gap-4 p-4">
                        <div class="col-span-full py-20 text-center">
                            <div class="spinner mb-3"></div>
                            <p class="text-xs text-gray-400">Menyinkronkan data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: HISTORY -->
            <div id="content-history" class="hidden fade-in">
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 text-center">
                    <label class="block font-bold text-gray-400 text-xs uppercase mb-3">Lihat Arsip Tanggal</label>
                    <input type="date" id="history-date" onchange="loadHistory()" class="border-2 border-gray-100 rounded-2xl px-6 py-3 text-sm font-bold outline-none focus:border-blue-500 text-gray-700">
                    <div id="history-result" class="mt-8">
                        <p class="text-gray-300 text-xs italic">Pilih tanggal untuk memuat data.</p>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: SETTINGS -->
            <div id="content-settings" class="hidden fade-in">
                <div class="max-w-md mx-auto bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-6 uppercase text-xs tracking-widest text-center">Tindakan Berbahaya</h3>
                    <button onclick="resetManual()" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-bold text-xs hover:bg-red-100 transition border border-red-100 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        RESET ABSENSI HARI INI
                    </button>
                    <p class="text-[10px] text-gray-400 mt-3 text-center leading-relaxed">
                        Data hari ini akan dihapus permanen dari server.<br>Siswa harus melakukan absen ulang.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDIT -->
    <div id="modal-edit" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm fade-in shadow-2xl scale-100">
            <h3 id="edit-name" class="font-black text-lg text-gray-800 mb-6">Nama Siswa</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Ubah Status</label>
                    <select id="edit-status" class="w-full bg-gray-50 border-transparent rounded-xl p-3 font-bold text-sm outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 transition">
                        <option value="hadir">Hadir</option>
                        <option value="terlambat">Terlambat</option>
                        <option value="izin">Izin</option>
                        <option value="sakit">Sakit</option>
                        <option value="alpa">Tanpa Keterangan (Alpha)</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Catatan</label>
                    <textarea id="edit-note" rows="3" class="w-full bg-gray-50 border-transparent rounded-xl p-3 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 transition" placeholder="Tulis catatan..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="closeModal()" class="py-3 rounded-xl font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 text-xs">BATAL</button>
                    <button onclick="saveEdit()" class="py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 text-xs shadow-lg">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI CERDAS ---
        let isOnline = false;
        let db, auth;
        let appId = 'smk-bm-offline'; 

        if (typeof __firebase_config !== 'undefined') {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isOnline = true;
            } catch (e) {
                console.warn("Config Firebase error, fallback ke Offline Mode.");
            }
        }

        const SISWA_DATA = [
            "Alvin Putra Pratama", "Andika", "Anwar Heriyansyah", "Arya Dimas Pratama",
            "Cornelius Rowen N", "Dafa Nofa Erlangga", "Devi Afriyanti", "Dila Mey Siska",
            "Elti Julianti Anthoneta B", "Fahri Maulana", "Faujiah Sulaesih", "Fina Ramadhani",
            "Fita Bunga", "Fitria Sari Gozali", "Kenzie Raditya Osas", "Leni Nur'aini",
            "M. Fahri Novian", "Muhammad Oki Cesa", "Muhammad Raihan", "Novitasari",
            "Parasha Hapizah Asipa", "Raihan Ardiansyah", "Rivky Jesen P", "Rofi Michael Yusuf",
            "Siti Amelia", "Tesa Lonika Saufani", "Theresia Yunita Jadi", "Zaiyan Izhan Idlan"
        ];

        let appState = { todayRecords: {} };
        let currentUser = null;

        const getTodayKey = () => {
            const d = new Date();
            return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0') + "-" + String(d.getDate()).padStart(2, '0');
        };

        // --- INIT ---
        window.onload = function() {
            renderSiswaSelect();
            startClock();
            
            // CEK APAKAH SUDAH ABSEN (FITUR BARU)
            checkDeviceAbsence();

            if (isOnline) {
                initAuth();
            } else {
                // Offline Mode Init
                document.getElementById('view-loading').classList.add('hidden');
                document.getElementById('connection-status').classList.remove('bg-green-500');
                document.getElementById('connection-status').classList.add('bg-orange-500');
                showToast("Mode Offline (Data tersimpan di HP ini saja)", "orange");
                
                const local = localStorage.getItem('absensi_' + getTodayKey());
                if (local) appState.todayRecords = JSON.parse(local);
            }
            
            router('siswa');
        };

        // FUNGSI CEK ABSEN PERANGKAT
        function checkDeviceAbsence() {
            // Cek jika key 'has_absen_TANGGAL' ada di LocalStorage
            if (localStorage.getItem('has_absen_' + getTodayKey())) {
                document.getElementById('form-container').classList.add('hidden'); // Sembunyikan form
                document.getElementById('success-message').classList.remove('hidden'); // Tampilkan pesan sukses
                
                // Ubah teks pesan
                document.querySelector('#success-message h2').innerText = "Sudah Absen";
                document.querySelector('#success-message p').innerText = "Perangkat ini sudah mencatat kehadiran hari ini.";
            }
        }

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Gagal:", err);
                showToast("Gagal koneksi server. Beralih ke offline.", "red");
                isOnline = false;
                document.getElementById('view-loading').classList.add('hidden');
            }
        }

        if (isOnline) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('view-loading').classList.add('hidden');
                    document.getElementById('connection-status').classList.add('bg-green-500');
                    document.getElementById('connection-status').classList.remove('bg-gray-300');
                    startRealtimeListener();
                }
            });
        }

        function startRealtimeListener() {
            const todayKey = getTodayKey();
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'presensi_harian', todayKey);

            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    appState.todayRecords = snap.data().records || {};
                } else {
                    appState.todayRecords = {};
                }
                if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                    renderAdminDashboard();
                }
            }, (err) => {
                console.error("Snapshot Error:", err);
            });
        }

        window.kirimAbsensi = async function() {
            const btn = document.getElementById('btn-absen');
            const name = document.getElementById('input-nama').value;
            
            if (!name) { showToast("Pilih nama Anda dulu!", "red"); return; }
            if (isOnline && !currentUser) { showToast("Sedang koneksi... Tunggu.", "orange"); return; }

            if (appState.todayRecords[name]) { showToast("Nama Anda sudah absen hari ini.", "blue"); return; }

            btn.disabled = true;
            btn.innerHTML = `<div class="spinner border-white border-t-transparent"></div>`;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
            const totalMins = (now.getHours() * 60) + now.getMinutes();
            const limitMins = (8 * 60) + 5; 
            const status = totalMins > limitMins ? "terlambat" : "hadir";

            const newRecord = { status, time: timeStr, note: "", timestamp: Date.now() };
            appState.todayRecords[name] = newRecord;

            try {
                if (isOnline) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'presensi_harian', getTodayKey());
                    await setDoc(docRef, { records: appState.todayRecords }, { merge: true });
                } else {
                    localStorage.setItem('absensi_' + getTodayKey(), JSON.stringify(appState.todayRecords));
                }

                // SIMPAN PENANDA DI HP (AGAR TIDAK BISA ABSEN LAGI)
                localStorage.setItem('has_absen_' + getTodayKey(), 'true');

                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                
                // Ubah teks jadi "Berhasil" normal untuk absen pertama kali
                document.querySelector('#success-message h2').innerText = "Berhasil!";
                document.querySelector('#success-message p').innerText = "Data kehadiran tersimpan di server.";

            } catch (e) {
                showToast("Gagal menyimpan: " + e.message, "red");
                btn.disabled = false;
                btn.innerText = "KIRIM KEHADIRAN";
            }
        };

        // --- ADMIN FUNCTIONS ---
        window.handleLogin = function(e) {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            if (pass === "admin123") { 
                router('admin-dashboard');
            } else { showToast("Password Salah!", "red"); }
        };

        window.renderAdminDashboard = function() {
            const container = document.getElementById('siswa-list');
            container.innerHTML = '';
            let sH = 0, sT = 0, sI = 0, sA = 0;

            SISWA_DATA.forEach(name => {
                const rec = appState.todayRecords[name];
                let st = 'ALPHA', tm = '--:--', color = 'border-l-4 border-gray-200 bg-white opacity-60';
                
                if (rec) {
                    tm = rec.time;
                    color = 'border-l-4 bg-white shadow-sm';
                    if (rec.status === 'hadir') { color += ' border-green-500'; st = 'HADIR'; sH++; }
                    else if (rec.status === 'terlambat') { color += ' border-red-500'; st = 'TELAT'; sT++; }
                    else if (['izin', 'sakit'].includes(rec.status)) { color += ' border-blue-500'; st = rec.status.toUpperCase(); sI++; }
                    else { sA++; }
                } else { sA++; }

                const div = document.createElement('div');
                div.className = `p-4 rounded-xl flex justify-between items-center ${color} hover:bg-gray-50 cursor-pointer transition`;
                div.onclick = () => openEditModal(name);
                div.innerHTML = `
                    <div class="truncate pr-2">
                        <h4 class="font-bold text-gray-800 text-xs uppercase">${name}</h4>
                        ${rec?.note ? `<p class="text-[10px] text-blue-500 italic truncate">"${rec.note}"</p>` : ''}
                    </div>
                    <div class="text-right shrink-0">
                        <span class="text-[9px] font-black bg-gray-100 px-2 py-1 rounded text-gray-500">${st}</span>
                        <p class="text-[10px] font-mono font-bold mt-1 text-gray-400">${tm}</p>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('stat-hadir').innerText = sH;
            document.getElementById('stat-telat').innerText = sT;
            document.getElementById('stat-izin').innerText = sI;
            document.getElementById('stat-alpha').innerText = sA;
        };

        window.saveEdit = async function() {
            const name = document.getElementById('edit-id').value;
            const status = document.getElementById('edit-status').value;
            const note = document.getElementById('edit-note').value;
            
            if (status === 'alpa') {
                delete appState.todayRecords[name];
            } else {
                appState.todayRecords[name] = {
                    status, 
                    time: appState.todayRecords[name]?.time || "00:00", 
                    note, 
                    timestamp: Date.now() 
                };
            }

            if (isOnline) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'presensi_harian', getTodayKey());
                await setDoc(docRef, { records: appState.todayRecords }, { merge: true });
            } else {
                localStorage.setItem('absensi_' + getTodayKey(), JSON.stringify(appState.todayRecords));
                renderAdminDashboard();
            }
            closeModal();
            showToast("Data siswa diperbarui", "green");
        };

        window.resetManual = async function() {
            if (!confirm("Yakin hapus data hari ini?")) return;
            appState.todayRecords = {};
            if (isOnline) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'presensi_harian', getTodayKey());
                await setDoc(docRef, { records: {} });
            } else {
                localStorage.removeItem('absensi_' + getTodayKey());
                renderAdminDashboard();
            }
            showToast("Data berhasil di-reset", "blue");
        };

        // --- UTILS ---
        window.showToast = function(msg, type = 'blue') {
            const el = document.createElement('div');
            const colors = { red: 'bg-red-500', green: 'bg-green-500', blue: 'bg-gray-800', orange: 'bg-orange-500' };
            el.className = `toast ${colors[type] || 'bg-gray-800'}`;
            el.innerText = msg;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        };

        window.router = function(page) {
            ['siswa', 'admin-login', 'admin-dashboard'].forEach(p => document.getElementById('view-' + p).classList.add('hidden'));
            document.getElementById('view-' + page).classList.remove('hidden');
            if (page === 'admin-dashboard') renderAdminDashboard();
        };

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'text-white', 'bg-blue-600');
                b.classList.add('text-gray-400');
            });
            const btn = document.getElementById('tab-' + tab);
            btn.classList.add('active');
            btn.classList.remove('text-gray-400');
            
            ['today', 'history', 'settings'].forEach(c => document.getElementById('content-' + c).classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');
        };

        function renderSiswaSelect() {
            const s = document.getElementById('input-nama');
            SISWA_DATA.forEach(n => { const o = document.createElement('option'); o.value=n; o.text=n; s.add(o); });
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString('id-ID', {hour12: false});
                
                // Status Logic
                const totalMins = (now.getHours() * 60) + now.getMinutes();
                const limit = (8 * 60) + 5; 
                const info = document.getElementById('status-info');
                info.classList.remove('hidden', 'bg-red-50', 'text-red-600', 'bg-green-50', 'text-green-600', 'border-red-200', 'border-green-200');
                
                if (totalMins > limit) {
                    info.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                    info.innerText = "Monitoring: TERLAMBAT (Lewat 08:05)";
                } else {
                    info.classList.add('bg-green-50', 'text-green-600', 'border-green-200');
                    info.innerText = "Monitoring: TEPAT WAKTU";
                }
            }, 1000);
        }

        window.openEditModal = (name) => {
            const r = appState.todayRecords[name] || {};
            document.getElementById('edit-id').value = name;
            document.getElementById('edit-name').innerText = name;
            document.getElementById('edit-status').value = r.status || 'alpa';
            document.getElementById('edit-note').value = r.note || '';
            document.getElementById('modal-edit').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modal-edit').classList.add('hidden');
        
        window.loadHistory = async function() {
            const date = document.getElementById('history-date').value;
            const res = document.getElementById('history-result');
            res.innerHTML = '<div class="spinner"></div>';
            
            let hData = {};
            if (isOnline) {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presensi_harian', date));
                if (snap.exists()) hData = snap.data().records;
            } else {
                const local = localStorage.getItem('absensi_' + date);
                if (local) hData = JSON.parse(local);
            }

            if (!hData || Object.keys(hData).length === 0) { res.innerHTML = '<p class="text-red-400 text-xs">Tidak ada data pada tanggal ini.</p>'; return; }
            
            let html = `<div class="bg-gray-50 rounded-xl p-4 text-left space-y-2">`;
            SISWA_DATA.forEach(n => {
                if(hData[n]) html += `<div class="flex justify-between text-xs border-b border-gray-200 pb-1"><span>${n}</span><span class="font-bold">${hData[n].status.toUpperCase()}</span></div>`;
            });
            res.innerHTML = html + '</div>';
        };

        window.exportExcel = function() {
            const data = SISWA_DATA.map(n => {
                const r = appState.todayRecords[n];
                return { Nama: n, Status: r?r.status:'Alpha', Jam: r?r.time:'-', Catatan: r?r.note:'' };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi");
            XLSX.writeFile(wb, `Absen_${getTodayKey()}.xlsx`);
        };
    </script>
</body>
</html>