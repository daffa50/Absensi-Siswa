<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>E-Presensi SMK Bina Mandiri (Online)</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <!-- Libraries for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: "Poppins", sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        .bg-cover-custom { 
            /* Menggunakan background gradient biru gelap sebagai fallback jika gambar tidak ada */
            background: linear-gradient(rgba(0, 50, 100, 0.8), rgba(0, 20, 50, 0.9));
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .tab-btn.active { background-color: #1e40af; color: white; font-weight: 700; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #1e40af; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">

    <!-- VIEW: PRESENSI SISWA -->
    <div id="view-siswa" class="hidden min-h-screen bg-cover-custom flex flex-col items-center justify-center p-4">
        <div class="glass-panel rounded-[2rem] w-full max-w-lg p-8 text-center fade-in">
            <!-- Placeholder Logo -->
            <div class="h-24 w-24 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-2xl shadow-lg">SMK</div>
            
            <h1 class="text-2xl font-black text-gray-800">E-Presensi SMK BM</h1>
            <p class="text-blue-700 font-bold text-xs mb-6 uppercase tracking-widest">Sistem Kehadiran Digital (Online)</p>

            <div id="form-container" class="space-y-5 text-left">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-blue-500 uppercase">Waktu Digital</p>
                        <h2 id="clock-display" class="text-2xl font-black text-blue-900">00:00:00</h2>
                    </div>
                    <button onclick="router('admin-login')" class="p-2 text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </button>
                </div>

                <div id="status-info" class="text-[10px] font-bold text-center py-2 px-4 rounded-lg bg-yellow-100 text-yellow-700 hidden">
                    <!-- Status Telat/Masuk Info -->
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Pilih Nama Anda</label>
                    <select id="input-nama" class="w-full p-4 bg-white border-2 border-gray-100 rounded-2xl font-semibold outline-none focus:border-blue-500 appearance-none">
                        <option value="">-- Cari Nama Anda --</option>
                    </select>
                    <p class="text-[10px] text-gray-400 mt-2 ml-1">*Hanya bisa absen 1 kali setiap hari.</p>
                </div>

                <button onclick="kirimAbsensi()" id="btn-absen" class="w-full bg-blue-700 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-blue-800 transition-all flex justify-center items-center gap-2">
                    KIRIM KEHADIRAN
                </button>
            </div>

            <div id="success-message" class="hidden py-10 flex flex-col items-center">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4 animate-bounce">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h2 class="text-xl font-black text-gray-800">Berhasil Terkirim!</h2>
                <p class="text-gray-500 text-sm mt-2">Data absen telah disinkronkan ke Admin.</p>
                <button onclick="window.location.reload()" class="mt-8 text-blue-500 text-xs font-bold uppercase hover:underline">Kembali</button>
            </div>
        </div>
    </div>

    <!-- VIEW: ADMIN LOGIN -->
    <div id="view-admin-login" class="hidden min-h-screen bg-cover-custom flex items-center justify-center p-4">
        <div class="glass-panel rounded-[2.5rem] w-full max-w-md p-10 text-center fade-in">
            <div class="h-16 w-16 bg-gray-800 rounded-full mx-auto mb-6 flex items-center justify-center text-white font-bold text-xl">BM</div>
            <h2 class="text-xl font-black text-gray-800 mb-8 tracking-tight text-center uppercase">Login Administrator</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="password" id="admin-password" placeholder="Kode Keamanan" class="w-full px-6 py-4 text-center text-lg font-mono border-2 border-gray-100 rounded-2xl outline-none focus:border-blue-600 transition" required>
                <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-xl">MASUK PANEL</button>
            </form>
            <button onclick="router('siswa')" class="mt-6 text-[10px] font-bold text-gray-400 uppercase tracking-widest hover:text-blue-500">Kembali ke Halaman Siswa</button>
        </div>
    </div>

    <!-- VIEW: ADMIN DASHBOARD -->
    <div id="view-admin-dashboard" class="hidden min-h-screen bg-gray-50">
        <header class="bg-white border-b sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-blue-700 rounded-full flex items-center justify-center text-white text-xs font-bold">BM</div>
                <h1 class="text-sm font-black text-gray-800 uppercase tracking-tighter">Admin SMK BM <span class="text-green-500 text-[10px] ml-1">‚óè ONLINE</span></h1>
            </div>
            <button onclick="logout()" class="text-red-500 font-bold text-xs uppercase bg-red-50 px-4 py-2 rounded-xl">Keluar</button>
        </header>

        <main class="container mx-auto px-4 py-6">
            <!-- Tabs -->
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <button onclick="switchTab('today')" id="tab-today" class="tab-btn active px-6 py-3 rounded-xl text-xs whitespace-nowrap bg-white text-gray-500 shadow-sm transition-all">Hari Ini</button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-btn px-6 py-3 rounded-xl text-xs whitespace-nowrap bg-white text-gray-500 shadow-sm transition-all">Arsip Riwayat</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-6 py-3 rounded-xl text-xs whitespace-nowrap bg-white text-gray-500 shadow-sm transition-all">QRIS & Pengaturan</button>
            </div>

            <!-- TAB CONTENT: TODAY -->
            <div id="content-today" class="fade-in">
                <!-- Indikator Loading Data -->
                <div id="loading-indicator" class="w-full text-center py-2 hidden">
                    <div class="spinner"></div> <span class="text-xs text-gray-400 ml-2">Menyinkronkan data...</span>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-2xl border-b-4 border-green-500 shadow-sm">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Hadir</p>
                        <h3 class="text-2xl font-black" id="stat-hadir">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border-b-4 border-red-500 shadow-sm">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Terlambat</p>
                        <h3 class="text-2xl font-black" id="stat-telat">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border-b-4 border-blue-500 shadow-sm">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Izin/Sakit</p>
                        <h3 class="text-2xl font-black" id="stat-izin">0</h3>
                    </div>
                    <div class="bg-gray-800 text-white p-4 rounded-2xl border-b-4 border-gray-600 shadow-sm">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Tanpa Ket</p>
                        <h3 class="text-2xl font-black" id="stat-alpha">0</h3>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-gray-800">Daftar Kehadiran</h2>
                        <div class="flex gap-2">
                            <button onclick="exportExcel()" class="bg-green-600 text-white p-2 rounded-lg text-[10px] font-bold hover:bg-green-700">DOWNLOAD EXCEL</button>
                        </div>
                    </div>
                    <div id="siswa-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Rendered Items -->
                        <div class="col-span-2 text-center text-gray-400 text-xs italic py-10">Menunggu data...</div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: HISTORY -->
            <div id="content-history" class="hidden fade-in">
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex items-center gap-4 mb-6">
                        <label class="font-bold text-gray-600 text-xs uppercase">Pilih Tanggal Riwayat:</label>
                        <input type="date" id="history-date" onchange="loadHistory()" class="border-2 border-gray-100 rounded-xl px-4 py-2 text-xs outline-none focus:border-blue-500">
                    </div>
                    <div id="history-result" class="min-h-[200px] flex items-center justify-center text-gray-400 italic text-xs bg-gray-50 rounded-2xl border-2 border-dashed">
                        Silakan pilih tanggal untuk melihat arsip server.
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: SETTINGS -->
            <div id="content-settings" class="hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-3xl p-6 shadow-sm text-center">
                        <h3 class="font-bold text-gray-800 mb-4 uppercase text-xs tracking-widest">QRIS Absensi Siswa</h3>
                        <div class="bg-gray-50 p-4 rounded-2xl border-2 border-dashed border-gray-200 inline-block">
                            <div class="h-64 w-64 bg-gray-200 rounded-xl flex items-center justify-center text-gray-400">
                                [Area Gambar QRIS]
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-4">Tunjukkan QRIS ini di depan kelas/gerbang.</p>
                    </div>
                    <div class="bg-white rounded-3xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-6 uppercase text-xs tracking-widest">Pengaturan Sistem</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-xl">
                                <h4 class="font-bold text-blue-800 text-[10px] uppercase">Waktu Masuk</h4>
                                <p class="text-[10px] text-blue-600 mt-1 leading-relaxed">Senin-Kamis: 07:30 - 14:00<br>Jumat: 07:30 - 11:00<br>Batas Terlambat: +35 Menit (08:05)</p>
                            </div>
                            <button onclick="resetManual()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold text-xs shadow-lg hover:bg-red-700">RESET DATA HARI INI</button>
                            <p class="text-[10px] text-red-400 italic text-center">Data hari ini akan di-reset di server pusat.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDIT ADMIN -->
    <div id="modal-edit" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm fade-in shadow-2xl">
            <h3 id="edit-name" class="font-black text-xl text-gray-800 mb-6">Nama Siswa</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Ubah Status</label>
                    <select id="edit-status" class="w-full border-2 border-gray-100 rounded-xl p-3 font-semibold outline-none focus:border-blue-500">
                        <option value="hadir">Hadir</option>
                        <option value="terlambat">Terlambat</option>
                        <option value="izin">Izin</option>
                        <option value="sakit">Sakit</option>
                        <option value="alpa">Tanpa Keterangan (Alpha)</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Catatan / Alasan Pulang Cepat</label>
                    <textarea id="edit-note" rows="3" class="w-full border-2 border-gray-100 rounded-xl p-3 text-sm outline-none focus:border-blue-500" placeholder="Contoh: Pulang jam 10:00 krn pusing..."></textarea>
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-400 hover:bg-gray-50 text-xs uppercase">Batal</button>
                    <button onclick="saveEdit()" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 text-xs shadow-lg uppercase">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK & LOGIC (REAL-TIME UPDATE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI OTOMATIS (ENVIRONMENT) ---
        // Kode ini membaca konfigurasi sistem secara otomatis. Tidak perlu edit manual.
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DATA SISWA
        const SISWA_DATA = [
            "Alvin Putra Pratama", "Andika", "Anwar Heriyansyah", "Arya Dimas Pratama",
            "Cornelius Rowen N", "Dafa Nofa Erlangga", "Devi Afriyanti", "Dila Mey Siska",
            "Elti Julianti Anthoneta B", "Fahri Maulana", "Faujiah Sulaesih", "Fina Ramadhani",
            "Fita Bunga", "Fitria Sari Gozali", "Kenzie Raditya Osas", "Leni Nur'aini",
            "M. Fahri Novian", "Muhammad Oki Cesa", "Muhammad Raihan", "Novitasari",
            "Parasha Hapizah Asipa", "Raihan Ardiansyah", "Rivky Jesen P", "Rofi Michael Yusuf",
            "Siti Amelia", "Tesa Lonika Saufani", "Theresia Yunita Jadi", "Zaiyan Izhan Idlan"
        ];

        let appState = { todayRecords: {} };
        let currentUser = null;

        const getTodayKey = () => {
            const d = new Date();
            return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0') + "-" + String(d.getDate()).padStart(2, '0');
        };

        // --- AUTH & INIT ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                alert("Gagal koneksi ke server database.");
            }
        }

        window.onload = function() {
            initAuth();
            renderSiswaSelect();
            startClock();
            router('siswa');
        };

        // Listener Login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                startRealtimeListener();
            }
        });

        // --- DATABASE LISTENER (JANTUNG SISTEM) ---
        function startRealtimeListener() {
            if (!currentUser) return;
            const todayKey = getTodayKey();
            
            // Menggunakan path yang VALID (6 Segmen): artifacts / appId / public / data / data_absensi / tanggal
            // Sebelumnya error karena 5 segmen (ganjil).
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'data_absensi', todayKey);

            document.getElementById('loading-indicator').classList.remove('hidden');

            onSnapshot(docRef, (snap) => {
                document.getElementById('loading-indicator').classList.add('hidden');
                
                if (snap.exists()) {
                    appState.todayRecords = snap.data().records || {};
                } else {
                    appState.todayRecords = {};
                }

                // Render ulang jika Admin sedang buka dashboard
                if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                    renderAdminDashboard();
                }
            }, (error) => {
                console.error("Error listener:", error);
            });
        }

        // --- UI FUNCTIONS ---
        function renderSiswaSelect() {
            const select = document.getElementById('input-nama');
            SISWA_DATA.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                select.appendChild(opt);
            });
        }

        function startClock() {
            const infoBox = document.getElementById('status-info');
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
                
                const day = now.getDay(); 
                const hour = now.getHours();
                const minute = now.getMinutes();
                const totalMins = (hour * 60) + minute;
                const limitMins = (8 * 60) + 5; 

                infoBox.classList.remove('hidden');
                if (day === 0 || day === 6) {
                    infoBox.innerText = "HARI LIBUR";
                } else if (totalMins > limitMins) {
                    infoBox.innerText = "ANDA TERLAMBAT (LEWAT 08:05)";
                    infoBox.className = "text-[10px] font-bold text-center py-2 px-4 rounded-lg bg-red-100 text-red-700";
                } else {
                    infoBox.innerText = "STATUS: TEPAT WAKTU";
                    infoBox.className = "text-[10px] font-bold text-center py-2 px-4 rounded-lg bg-green-100 text-green-700";
                }
            }, 1000);
        }

        // --- FUNGSI ABSEN SISWA ---
        window.kirimAbsensi = async function() {
            const btn = document.getElementById('btn-absen');
            const name = document.getElementById('input-nama').value;
            
            if (!currentUser) { alert("Sedang menghubungkan ke server... Tunggu sebentar."); return; }
            if (!name) { alert("Pilih nama Anda!"); return; }

            // Cek Double Absen di Data Global (Server)
            if (appState.todayRecords[name]) {
                alert("Nama Anda sudah terdaftar absen hari ini di server.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<div class="spinner border-white border-t-transparent w-4 h-4"></div> Mengirim...`;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
            const totalMins = (now.getHours() * 60) + now.getMinutes();
            const limitMins = (8 * 60) + 5; 
            const status = totalMins > limitMins ? "terlambat" : "hadir";

            // Update state lokal dulu
            const newRecord = { status, time: timeStr, note: "", timestamp: Date.now() };
            appState.todayRecords[name] = newRecord;

            // Kirim ke server
            await saveToBackend(getTodayKey(), appState.todayRecords);

            // Simpan marker di HP agar tidak bisa absen lagi
            localStorage.setItem('has_absen_' + getTodayKey(), 'true');

            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('success-message').classList.remove('hidden');
            btn.disabled = false;
        };

        async function saveToBackend(key, data) {
            if (!currentUser) return;
            // UPDATE: Menambahkan 'data_absensi' agar path menjadi genap (6 segmen)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'data_absensi', key);
            try {
                await setDoc(docRef, { records: data }, { merge: true });
            } catch (e) {
                console.error("Gagal simpan:", e);
                alert("Gagal menyimpan data ke server.");
            }
        }

        // --- ADMIN LOGIC ---
        window.handleLogin = function(e) {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            if (pass === "admin123") { 
                localStorage.setItem('isAuthBM', 'true');
                router('admin-dashboard');
            } else { alert("Kode Salah!"); }
        };

        window.logout = function() {
            localStorage.removeItem('isAuthBM');
            router('siswa');
        };

        window.renderAdminDashboard = function() {
            const container = document.getElementById('siswa-list');
            container.innerHTML = '';
            let sH = 0, sT = 0, sI = 0, sA = 0;

            SISWA_DATA.forEach(name => {
                const rec = appState.todayRecords[name];
                const card = document.createElement('div');
                let cls = 'bg-white border-gray-100';
                let st = 'BELUM ABSEN', tm = '--:--', bCls = 'bg-gray-100 text-gray-400';

                if (rec) {
                    tm = rec.time;
                    if (rec.status === 'hadir') { cls = 'border-green-500 bg-green-50'; st = 'HADIR'; bCls = 'bg-green-100 text-green-700'; sH++; }
                    else if (rec.status === 'terlambat') { cls = 'border-red-500 bg-red-50'; st = 'TELAT'; bCls = 'bg-red-100 text-red-700'; sT++; }
                    else if (rec.status === 'izin' || rec.status === 'sakit') { cls = 'border-blue-500 bg-blue-50'; st = rec.status.toUpperCase(); bCls = 'bg-blue-100 text-blue-700'; sI++; }
                    else { sA++; }
                } else { sA++; }

                card.className = `p-4 rounded-2xl border-l-4 shadow-sm flex justify-between items-center cursor-pointer hover:scale-[1.01] transition ${cls}`;
                card.onclick = () => openEditModal(name);
                card.innerHTML = `
                    <div class="overflow-hidden mr-2">
                        <h4 class="font-bold text-gray-800 text-[11px] truncate uppercase">${name}</h4>
                        ${rec && rec.note ? `<p class="text-[9px] text-blue-600 truncate mt-1 italic">"${rec.note}"</p>` : ''}
                    </div>
                    <div class="text-right shrink-0">
                        <span class="px-2 py-0.5 rounded-md text-[8px] font-black ${bCls}">${st}</span>
                        <p class="text-[10px] font-mono font-bold mt-1 text-gray-500">${tm}</p>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('stat-hadir').innerText = sH;
            document.getElementById('stat-telat').innerText = sT;
            document.getElementById('stat-izin').innerText = sI;
            document.getElementById('stat-alpha').innerText = sA;
        };

        window.openEditModal = function(name) {
            const rec = appState.todayRecords[name] || {};
            document.getElementById('edit-id').value = name;
            document.getElementById('edit-name').innerText = name;
            document.getElementById('edit-status').value = rec.status || 'alpa';
            document.getElementById('edit-note').value = rec.note || '';
            document.getElementById('modal-edit').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modal-edit').classList.add('hidden');

        window.saveEdit = async function() {
            const name = document.getElementById('edit-id').value;
            const status = document.getElementById('edit-status').value;
            const note = document.getElementById('edit-note').value;

            if (status === 'alpa') {
                delete appState.todayRecords[name];
            } else {
                appState.todayRecords[name] = {
                    status: status,
                    time: appState.todayRecords[name]?.time || "00:00",
                    note: note,
                    timestamp: Date.now()
                };
            }
            await saveToBackend(getTodayKey(), appState.todayRecords);
            closeModal();
            // Tidak perlu panggil renderAdminDashboard() manual, karena onSnapshot akan menangkap perubahannya
        };

        window.resetManual = async function() {
            if (confirm("Hapus semua absen hari ini di SERVER? Semua data murid hari ini akan hilang.")) {
                appState.todayRecords = {};
                await saveToBackend(getTodayKey(), {});
            }
        };

        // --- NAVIGATION ---
        window.router = function(page) {
            document.getElementById('view-siswa').classList.add('hidden');
            document.getElementById('view-admin-login').classList.add('hidden');
            document.getElementById('view-admin-dashboard').classList.add('hidden');

            if (page === 'admin-dashboard' && localStorage.getItem('isAuthBM') !== 'true') page = 'admin-login';
            document.getElementById('view-' + page).classList.remove('hidden');
            if (page === 'admin-dashboard') renderAdminDashboard();
        };

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            ['today', 'history', 'settings'].forEach(c => document.getElementById('content-' + c).classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');
        };

        // --- HISTORY ---
        window.loadHistory = async function() {
            const date = document.getElementById('history-date').value;
            const container = document.getElementById('history-result');
            
            if (!currentUser) return;

            container.innerHTML = '<div class="text-center w-full"><div class="spinner"></div><br>Mengambil data server...</div>';

            // UPDATE: Menambahkan 'data_absensi' agar path menjadi genap (6 segmen)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'data_absensi', date);
            const snap = await getDoc(docRef);
            
            let hData = {};
            if (snap.exists()) hData = snap.data().records;

            if (Object.keys(hData).length === 0) {
                container.innerHTML = 'Data tanggal ini belum ada di server.';
                return;
            }

            let html = `<table class="w-full text-[10px] text-left">
                <thead class="bg-gray-100"><tr><th class="p-2">Siswa</th><th class="p-2">Status</th><th class="p-2">Jam</th></tr></thead><tbody class="divide-y">`;
            SISWA_DATA.forEach(n => {
                const r = hData[n];
                html += `<tr><td class="p-2 font-bold">${n}</td><td class="p-2">${r?r.status.toUpperCase():'ALPHA'}</td><td class="p-2 font-mono">${r?r.time:'-'}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
        };

        window.exportExcel = function() {
            const exportData = SISWA_DATA.map(n => {
                const r = appState.todayRecords[n];
                return { 'Nama': n, 'Status': r?r.status:'Alpha', 'Jam': r?r.time:'-', 'Catatan': r?r.note:'' };
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi");
            XLSX.writeFile(wb, `Absen_BM_${getTodayKey()}.xlsx`);
        };

    </script>
</body>
</html>