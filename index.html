<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>E-Presensi SMK Bina Mandiri</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { 
            font-family: "Poppins", sans-serif; 
            background-color: #f3f4f6; 
            overflow-x: hidden; 
        }
        
        /* Background Login & Siswa */
        .bg-cover-custom { 
            background: linear-gradient(rgba(0, 50, 100, 0.8), rgba(0, 20, 50, 0.9)), 
                        url('unnamed.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Glassmorphism Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .tab-btn.active { 
            background-color: #1e40af; 
            color: white; 
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.3);
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- ========================================= -->
    <!-- HALAMAN 1: PRESENSI SISWA (PUBLIC)        -->
    <!-- ========================================= -->
    <div id="view-siswa" class="hidden min-h-screen bg-cover-custom flex flex-col items-center justify-center p-4">
        <div class="glass-panel rounded-[2rem] w-full max-w-lg p-8 text-center fade-in relative overflow-hidden">
            <!-- Header Logo -->
            <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
            <img src="logo.png" alt="Logo Sekolah" class="h-24 mx-auto mb-4 drop-shadow-lg transform hover:scale-105 transition duration-500">
            
            <h1 class="text-2xl font-black text-gray-800 tracking-tight">E-Presensi Siswa</h1>
            <p class="text-blue-700 font-bold text-sm mb-8 uppercase tracking-widest">SMK Bina Mandiri</p>

            <!-- Form Area -->
            <div id="form-container" class="space-y-5 text-left">
                <!-- Info Waktu -->
                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 flex items-center justify-between shadow-sm">
                    <div>
                        <p class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Waktu Server</p>
                        <h2 id="clock-display" class="text-3xl font-black text-blue-900 tabular-nums">00:00:00</h2>
                        <p id="date-display" class="text-[10px] font-medium text-blue-400">Memuat tanggal...</p>
                    </div>
                    <!-- Tombol ke Admin Login -->
                    <button onclick="router('admin-login')" class="group p-2 rounded-xl hover:bg-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </button>
                </div>

                <!-- Pilihan Nama -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Nama Lengkap Siswa</label>
                    <div class="relative">
                        <select id="input-nama" class="w-full p-4 bg-white border-2 border-gray-100 rounded-2xl font-semibold text-gray-700 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition appearance-none cursor-pointer">
                            <option value="">-- Pilih Nama Anda --</option>
                            <!-- Data Siswa akan dirender di sini oleh JS -->
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 ml-1 italic">*Pastikan memilih nama yang benar. Hanya bisa absen 1x sehari.</p>
                </div>

                <!-- Tombol Absen -->
                <button onclick="kirimAbsensi()" id="btn-absen" class="w-full bg-gradient-to-r from-blue-700 to-blue-600 text-white py-4 rounded-2xl font-black text-lg shadow-xl shadow-blue-200 hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all duration-300">
                    KIRIM KEHADIRAN
                </button>
            </div>

            <!-- Layar Sukses (Hidden Default) -->
            <div id="success-message" class="hidden py-10 flex flex-col items-center">
                <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h2 class="text-2xl font-black text-gray-800">Berhasil Absen!</h2>
                <p class="text-gray-500 font-medium mt-2">Data Anda telah tersimpan di Admin.</p>
                <div class="mt-8 p-4 bg-gray-50 rounded-xl w-full">
                    <p class="text-[10px] text-gray-400 font-bold uppercase animate-pulse">Menutup halaman otomatis...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- HALAMAN 2: LOGIN ADMIN                    -->
    <!-- ========================================= -->
    <div id="view-admin-login" class="hidden min-h-screen bg-cover-custom flex items-center justify-center p-4">
        <div class="glass-panel rounded-[2.5rem] w-full max-w-md p-10 text-center fade-in">
            <img src="logo.png" alt="Logo" class="h-16 mx-auto mb-6">
            <h2 class="text-xl font-black text-gray-800 mb-1">Akses Administrator</h2>
            <p class="text-xs text-gray-500 mb-8">Masukkan kode akses untuk masuk panel.</p>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="password" id="admin-password" placeholder="Kode Keamanan" class="w-full px-6 py-4 text-center text-lg font-mono border-2 border-gray-200 rounded-2xl outline-none focus:border-blue-600 focus:ring-4 focus:ring-blue-100 transition" required>
                <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition shadow-lg">MASUK DASHBOARD</button>
            </form>
            <button onclick="router('siswa')" class="mt-6 text-[10px] font-bold text-gray-400 hover:text-white uppercase tracking-widest underline">Kembali ke Absen Siswa</button>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- HALAMAN 3: DASHBOARD ADMIN                -->
    <!-- ========================================= -->
    <div id="view-admin-dashboard" class="hidden min-h-screen bg-gray-50 pb-20">
        <!-- Navbar -->
        <header class="bg-white border-b sticky top-0 z-50 px-6 py-4 shadow-sm">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="unnamed.png" class="h-10">
                    <div>
                        <h1 class="text-lg font-black text-gray-800 leading-tight">Admin Panel</h1>
                        <p class="text-[10px] font-bold text-blue-600">SMK Bina Mandiri</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-50 text-red-600 p-2 rounded-xl hover:bg-red-600 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 mt-8">
            <!-- Tabs Navigation -->
            <div class="flex gap-4 mb-8 overflow-x-auto pb-2">
                <button onclick="switchTab('today')" id="tab-today" class="tab-btn active px-6 py-3 rounded-xl text-sm whitespace-nowrap transition-all">Monitoring Hari Ini</button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-btn bg-white text-gray-500 px-6 py-3 rounded-xl text-sm whitespace-nowrap transition-all hover:bg-gray-100">Arsip Riwayat</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn bg-white text-gray-500 px-6 py-3 rounded-xl text-sm whitespace-nowrap transition-all hover:bg-gray-100">QRIS & Pengaturan</button>
            </div>

            <!-- CONTENT: TODAY -->
            <div id="content-today" class="fade-in">
                <!-- Statistik Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border-b-4 border-green-500 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Tepat Waktu</p>
                        <h3 class="text-3xl font-black text-gray-800" id="stat-hadir">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border-b-4 border-red-500 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Terlambat (>35m)</p>
                        <h3 class="text-3xl font-black text-gray-800" id="stat-telat">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border-b-4 border-blue-500 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Izin / Sakit</p>
                        <h3 class="text-3xl font-black text-gray-800" id="stat-izin">0</h3>
                    </div>
                    <div class="bg-gray-800 text-white p-5 rounded-2xl border-b-4 border-gray-600 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Belum Absen</p>
                        <h3 class="text-3xl font-black" id="stat-alpha">0</h3>
                    </div>
                </div>

                <!-- List Siswa -->
                <div class="bg-white rounded-3xl shadow-sm p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="font-bold text-gray-800 text-lg">Rekap Absensi Live</h2>
                        <div class="flex gap-2">
                            <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-700">Excel</button>
                            <button onclick="exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-700">PDF</button>
                        </div>
                    </div>
                    
                    <div id="siswa-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Rendered Items -->
                    </div>
                </div>
            </div>

            <!-- CONTENT: HISTORY -->
            <div id="content-history" class="hidden fade-in">
                <div class="bg-white rounded-3xl p-8 shadow-sm">
                    <div class="flex items-center gap-4 mb-6">
                        <label class="font-bold text-gray-600 text-sm">Pilih Tanggal:</label>
                        <input type="date" id="history-date" onchange="loadHistory()" class="border-2 border-gray-200 rounded-xl px-4 py-2 text-sm outline-none focus:border-blue-500">
                    </div>
                    <div id="history-result" class="min-h-[200px] flex items-center justify-center text-gray-400 italic text-sm border-2 border-dashed border-gray-100 rounded-2xl bg-gray-50">
                        Silakan pilih tanggal untuk melihat data masa lalu.
                    </div>
                </div>
            </div>

            <!-- CONTENT: SETTINGS & QRIS -->
            <div id="content-settings" class="hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- QRIS Card -->
                    <div class="bg-white rounded-3xl p-8 shadow-sm text-center">
                        <h3 class="font-bold text-gray-800 mb-6 uppercase text-sm tracking-widest">QRIS Absensi</h3>
                        <div class="bg-gray-100 p-4 rounded-3xl inline-block border-2 border-dashed border-gray-300">
                            <img src="Absensi Siswa_i.jpg" alt="QRIS" class="h-64 rounded-xl shadow-inner">
                        </div>
                        <p class="text-xs text-gray-500 mt-4">Gunakan QRIS ini untuk keperluan administrasi.</p>
                    </div>

                    <!-- Config Card -->
                    <div class="bg-white rounded-3xl p-8 shadow-sm space-y-6">
                        <h3 class="font-bold text-gray-800 mb-6 uppercase text-sm tracking-widest">Pengaturan Sistem</h3>
                        
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <h4 class="font-bold text-blue-800 text-xs uppercase mb-2">Jadwal Masuk</h4>
                            <p class="text-xs text-blue-600">Senin - Kamis: 07:30 - 14:00</p>
                            <p class="text-xs text-blue-600">Jumat: 07:30 - 11:00</p>
                            <p class="text-xs text-red-500 mt-1 font-bold">*Terlambat jika absen lewat 08:05 (35 Menit)</p>
                        </div>

                        <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                            <h4 class="font-bold text-red-800 text-xs uppercase mb-2">Zona Bahaya</h4>
                            <button onclick="resetManual()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold text-xs hover:bg-red-700 shadow-lg">RESET DATA HARI INI (MANUAL)</button>
                            <p class="text-[10px] text-red-400 mt-2 italic">Data akan otomatis ter-reset setiap hari jam 16:00 WIB.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDIT STATUS SISWA -->
    <div id="modal-edit" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm fade-in shadow-2xl">
            <h3 id="edit-name" class="font-black text-xl text-gray-800 mb-1">Nama Siswa</h3>
            <p class="text-xs text-blue-600 font-bold uppercase mb-6">Edit Status Kehadiran</p>
            
            <input type="hidden" id="edit-id">
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Status</label>
                    <select id="edit-status" class="w-full border-2 border-gray-200 rounded-xl p-3 font-semibold outline-none focus:border-blue-500">
                        <option value="hadir">Hadir (Tepat Waktu)</option>
                        <option value="terlambat">Hadir (Terlambat)</option>
                        <option value="izin">Izin</option>
                        <option value="sakit">Sakit</option>
                        <option value="alpa">Alpa / Reset</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Catatan (Pulang Cepat/Alasan)</label>
                    <textarea id="edit-note" rows="3" class="w-full border-2 border-gray-200 rounded-xl p-3 text-sm outline-none focus:border-blue-500" placeholder="Contoh: Pulang jam 10:00 karena sakit..."></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 text-xs">BATAL</button>
                    <button onclick="saveEdit()" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 text-xs shadow-lg">SIMPAN PERUBAHAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // =========================================================================
        // KONFIGURASI FIREBASE (WAJIB DIISI AGAR ONLINE)
        // =========================================================================
        // 1. Buka console.firebase.google.com
        // 2. Buat project baru -> Pilih Web (icon </>)
        // 3. Copy config di bawah ini
        // =========================================================================
        const firebaseConfig = {
             apiKey: "API_KEY_ANDA_DISINI",
             authDomain: "PROJECT_ID.firebaseapp.com",
             projectId: "PROJECT_ID",
             storageBucket: "PROJECT_ID.firebasestorage.app",
             messagingSenderId: "SENDER_ID",
             appId: "APP_ID"
        };
        // =========================================================================

        let db;
        let isOnline = false;

        // Inisialisasi Firebase dengan Error Handling
        try {
            if (firebaseConfig.apiKey === "API_KEY_ANDA_DISINI") {
                console.warn("Firebase Config belum diisi. Aplikasi berjalan dalam Mode Offline (LocalStorage).");
            } else {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isOnline = true;
                console.log("Terhubung ke Firebase Cloud.");
            }
        } catch (e) {
            console.error("Gagal koneksi Firebase:", e);
        }

        // DATABASE SISWA
        const SISWA_DATA = [
            { name: "Anwar Heriyansyah", gender: "Laki Laki" },
            { name: "Dila Mey Siska", gender: "Perempuan" },
            { name: "Muhammad Oki Cesa", gender: "Laki Laki" },
            { name: "Novitasari", gender: "Perempuan" },
            { name: "Rofi Michael Yusuf", gender: "Laki Laki" },
            { name: "Zaiyan Izhan Idlan", gender: "Laki Laki" },
            { name: "Fina Ramadhani", gender: "Perempuan" },
            { name: "M. Fahri Novian", gender: "Laki Laki" },
            { name: "Andika", gender: "Laki Laki" },
            { name: "Dafa Nofa Erlangga", gender: "Laki Laki" },
            { name: "Fahri Maulana", gender: "Laki Laki" },
            { name: "Faujiah Sulaesih", gender: "Perempuan" },
            { name: "Kenzie Raditya Osas", gender: "Laki Laki" },
            { name: "Siti Amelia", gender: "Perempuan" },
            { name: "Tesa Lonika Saufani", gender: "Perempuan" },
            { name: "Theresia Yunita Jadi", gender: "Perempuan" },
            { name: "Fita Bunga", gender: "Perempuan" },
            { name: "Rivky Jesen P", gender: "Laki Laki" },
            { name: "Alvin Putra Pratama", gender: "Laki Laki" },
            { name: "Arya Dimas Pratama", gender: "Laki Laki" },
            { name: "Cornelius Rowen N", gender: "Laki Laki" },
            { name: "Devi Afriyanti", gender: "Perempuan" },
            { name: "Elti Julianti Anthoneta B", gender: "Perempuan" },
            { name: "Fitria Sari Gozali", gender: "Perempuan" },
            { name: "Leni Nur'aini", gender: "Perempuan" },
            { name: "Muhammad Raihan", gender: "Laki Laki" },
            { name: "Parasha Hapizah Asipa", gender: "Perempuan" },
            { name: "Raihan Ardiansyah", gender: "Laki Laki" }
        ].sort((a, b) => a.name.localeCompare(b.name)); // Urutkan nama A-Z

        // STATE GLOBAL
        let appState = {
            todayRecords: {} // { "Nama": { status, time, note } }
        };

        // Kunci Tanggal Hari Ini (Format YYYY-MM-DD)
        const getTodayKey = () => {
            const d = new Date();
            return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0') + "-" + String(d.getDate()).padStart(2, '0');
        };

        // --- SISTEM UTAMA ---
        window.onload = function() {
            initApp();
            renderSiswaSelect();
            startClock();
            
            // Cek hash untuk routing
            if(window.location.hash === '#admin') router('admin-login');
            else router('siswa');
        };

        // 1. Inisialisasi Data
        async function initApp() {
            const todayKey = getTodayKey();
            
            // Jika Online: Listen ke Firestore Realtime
            if (isOnline) {
                const docRef = doc(db, "absensi", todayKey);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        appState.todayRecords = docSnap.data().records || {};
                    } else {
                        appState.todayRecords = {};
                    }
                    // Jika sedang di dashboard admin, refresh tampilan
                    if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                        renderAdminDashboard();
                    }
                }, (error) => {
                    console.error("Error mengambil data live:", error);
                });
            } else {
                // Jika Offline: Pakai LocalStorage
                const savedData = localStorage.getItem('absen_' + todayKey);
                if (savedData) appState.todayRecords = JSON.parse(savedData);
            }

            // Cek Auto Reset jam 16:00
            checkAutoReset();
            setInterval(checkAutoReset, 60000); // Cek tiap menit
        }

        // 2. Logika Jam & Auto Reset
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', { hour12: false });
                document.getElementById('clock-display').innerText = timeString;
                document.getElementById('date-display').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }, 1000);
        }

        function checkAutoReset() {
            const now = new Date();
            // Reset jika jam 16:00
            if (now.getHours() === 16 && now.getMinutes() === 0) {
                window.location.reload();
            }
        }

        // 3. Render Dropdown Siswa
        function renderSiswaSelect() {
            const select = document.getElementById('input-nama');
            SISWA_DATA.forEach(s => {
                const option = document.createElement('option');
                option.value = s.name;
                option.textContent = s.name;
                select.appendChild(option);
            });
        }

        // 4. Proses Absensi Siswa
        window.kirimAbsensi = async function() {
            const nama = document.getElementById('input-nama').value;
            
            if (!nama) {
                alert("Mohon pilih nama Anda terlebih dahulu!");
                return;
            }

            // Cek apakah sudah absen hari ini
            if (appState.todayRecords[nama]) {
                alert("Anda sudah melakukan absensi hari ini. Tidak bisa absen dua kali.");
                return;
            }

            // Logika Waktu
            const now = new Date();
            const jam = now.getHours();
            const menit = now.getMinutes();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });

            // Aturan Telat: > 07:30 + 35 menit = 08:05
            // Logika: Jam > 8 ATAU (Jam == 8 DAN menit > 5) ATAU (Jam == 7 DAN menit > 65 -> impossible, logic handles >8:05)
            // Sederhana: ubah ke menit total dari 00:00
            const currentTotalMinutes = (jam * 60) + menit;
            const limitTotalMinutes = (8 * 60) + 5; // 08:05
            
            let status = "hadir";
            if (currentTotalMinutes > limitTotalMinutes) {
                status = "terlambat";
            }

            // Simpan Data
            const newRecord = {
                status: status,
                time: timeStr,
                note: "",
                timestamp: Date.now()
            };

            appState.todayRecords[nama] = newRecord;

            // Save ke Backend
            await saveDataToBackend(getTodayKey(), appState.todayRecords);

            // Simpan jejak di HP Siswa (LocalStorage) agar tidak bisa absen lagi meski refresh
            localStorage.setItem('has_absen_' + getTodayKey(), 'true');

            // Tampilkan Sukses
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('success-message').classList.remove('hidden');

            // Redirect Otomatis (Keluar Link)
            setTimeout(() => {
                window.location.href = "about:blank"; // Atau tutup tab jika didukung
                // Fallback jika tidak bisa close
                document.body.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;background:#f3f4f6;font-family:sans-serif;'><h1>Terima Kasih. Silakan tutup tab ini.</h1></div>";
            }, 3000);
        };

        // Helper Simpan Data
        async function saveDataToBackend(key, data) {
            if (isOnline) {
                try {
                    await setDoc(doc(db, "absensi", key), { records: data }, { merge: true });
                } catch (e) {
                    alert("Gagal menyimpan ke server: " + e.message);
                }
            } else {
                localStorage.setItem('absen_' + key, JSON.stringify(data));
            }
        }

        // =========================================================================
        // LOGIKA ADMIN
        // =========================================================================
        
        // Login
        window.handleLogin = function(e) {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            if (pass === "admin123") { // Password Admin
                localStorage.setItem('isAdmin', 'true');
                router('admin-dashboard');
            } else {
                alert("Password Salah!");
            }
        };

        window.logout = function() {
            localStorage.removeItem('isAdmin');
            router('siswa');
        };

        // Render Dashboard
        window.renderAdminDashboard = function() {
            const container = document.getElementById('siswa-list-container');
            container.innerHTML = '';
            
            let countHadir = 0, countTelat = 0, countIzin = 0, countAlpha = 0;

            SISWA_DATA.forEach(siswa => {
                const record = appState.todayRecords[siswa.name];
                const card = document.createElement('div');
                
                let statusColor = 'border-gray-200 bg-white';
                let statusText = 'BELUM ABSEN';
                let timeText = '-';
                let badgeClass = 'bg-gray-100 text-gray-400';

                if (record) {
                    timeText = record.time;
                    if (record.status === 'hadir') {
                        statusColor = 'border-green-500 bg-green-50';
                        statusText = 'HADIR';
                        badgeClass = 'bg-green-100 text-green-700';
                        countHadir++;
                    } else if (record.status === 'terlambat') {
                        statusColor = 'border-red-500 bg-red-50';
                        statusText = 'TERLAMBAT';
                        badgeClass = 'bg-red-100 text-red-700';
                        countTelat++;
                    } else if (record.status === 'izin' || record.status === 'sakit') {
                        statusColor = 'border-blue-500 bg-blue-50';
                        statusText = record.status.toUpperCase();
                        badgeClass = 'bg-blue-100 text-blue-700';
                        countIzin++;
                    } else {
                        countAlpha++; // Alpa manual
                    }
                } else {
                    countAlpha++;
                }

                card.className = `p-4 rounded-xl border-l-4 shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center ${statusColor}`;
                card.onclick = () => openEditModal(siswa.name);

                card.innerHTML = `
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm">${siswa.name}</h4>
                        <p class="text-[10px] text-gray-500 font-bold uppercase mt-1">${siswa.gender}</p>
                        ${record && record.note ? `<p class="text-[9px] text-blue-600 italic mt-1">"${record.note}"</p>` : ''}
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 rounded text-[9px] font-bold ${badgeClass}">${statusText}</span>
                        <p class="text-xs font-mono font-bold mt-1 text-gray-600">${timeText}</p>
                    </div>
                `;
                container.appendChild(card);
            });

            // Update Statistik
            document.getElementById('stat-hadir').innerText = countHadir;
            document.getElementById('stat-telat').innerText = countTelat;
            document.getElementById('stat-izin').innerText = countIzin;
            document.getElementById('stat-alpha').innerText = countAlpha;
        };

        // Edit Status
        window.openEditModal = function(name) {
            const record = appState.todayRecords[name] || {};
            document.getElementById('edit-id').value = name;
            document.getElementById('edit-name').innerText = name;
            document.getElementById('edit-status').value = record.status || 'alpa';
            document.getElementById('edit-note').value = record.note || '';
            
            document.getElementById('modal-edit').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('modal-edit').classList.add('hidden');
        };

        window.saveEdit = async function() {
            const name = document.getElementById('edit-id').value;
            const status = document.getElementById('edit-status').value;
            const note = document.getElementById('edit-note').value;

            if (status === 'alpa') {
                delete appState.todayRecords[name];
            } else {
                const now = new Date();
                appState.todayRecords[name] = {
                    status: status,
                    time: appState.todayRecords[name]?.time || now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', hour12:false}),
                    note: note,
                    timestamp: Date.now()
                };
            }

            await saveDataToBackend(getTodayKey(), appState.todayRecords);
            closeModal();
            renderAdminDashboard(); // Refresh UI manual jika offline, online auto refresh via snapshot
        };

        window.resetManual = async function() {
            if (confirm("Yakin ingin menghapus semua data absensi hari ini? Tindakan ini tidak bisa dibatalkan.")) {
                appState.todayRecords = {};
                await saveDataToBackend(getTodayKey(), {});
                renderAdminDashboard();
                alert("Data hari ini berhasil direset.");
            }
        };

        // --- NAVIGASI ---
        window.router = function(page) {
            document.getElementById('view-siswa').classList.add('hidden');
            document.getElementById('view-admin-login').classList.add('hidden');
            document.getElementById('view-admin-dashboard').classList.add('hidden');

            if (page === 'siswa') {
                document.getElementById('view-siswa').classList.remove('hidden');
                // Cek jika sudah absen di device ini (Local Check)
                if (localStorage.getItem('has_absen_' + getTodayKey())) {
                   // Opsional: Langsung tampilkan pesan sukses jika ingin membatasi strict
                }
            } else if (page === 'admin-login') {
                document.getElementById('view-admin-login').classList.remove('hidden');
            } else if (page === 'admin-dashboard') {
                if (localStorage.getItem('isAdmin') === 'true') {
                    document.getElementById('view-admin-dashboard').classList.remove('hidden');
                    renderAdminDashboard();
                } else {
                    router('admin-login');
                }
            }
        };

        window.switchTab = function(tabName) {
            // Hide all
            document.getElementById('content-today').classList.add('hidden');
            document.getElementById('content-history').classList.add('hidden');
            document.getElementById('content-settings').classList.add('hidden');
            
            // Reset Buttons
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'bg-blue-800', 'text-white');
                b.classList.add('bg-white', 'text-gray-500');
            });

            // Show active
            document.getElementById('content-' + tabName).classList.remove('hidden');
            const btn = document.getElementById('tab-' + tabName);
            btn.classList.add('active');
            btn.classList.remove('bg-white', 'text-gray-500');
        };

        // --- HISTORY ---
        window.loadHistory = async function() {
            const date = document.getElementById('history-date').value;
            if (!date) return;

            const container = document.getElementById('history-result');
            container.innerHTML = '<p class="animate-pulse font-bold text-blue-500">Memuat data...</p>';

            let historyData = {};

            if (isOnline) {
                try {
                    const snap = await getDoc(doc(db, "absensi", date));
                    if (snap.exists()) historyData = snap.data().records;
                } catch(e) { console.error(e); }
            } else {
                const local = localStorage.getItem('absen_' + date);
                if (local) historyData = JSON.parse(local);
            }

            if (Object.keys(historyData).length === 0) {
                container.innerHTML = '<p class="text-red-500 font-bold">Tidak ada data pada tanggal ini.</p>';
                return;
            }

            // Render Table
            let html = `<div class="w-full overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600 uppercase font-bold"><tr><th class="p-3">Nama</th><th class="p-3">Status</th><th class="p-3">Waktu</th><th class="p-3">Ket</th></tr></thead><tbody class="divide-y">`;
            
            SISWA_DATA.forEach(s => {
                const r = historyData[s.name];
                html += `<tr>
                    <td class="p-3 font-medium">${s.name}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${r ? (r.status=='hadir'?'bg-green-100 text-green-700': r.status=='terlambat'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700') : 'text-gray-300'}">${r ? r.status.toUpperCase() : 'ALPA'}</span></td>
                    <td class="p-3 font-mono">${r ? r.time : '-'}</td>
                    <td class="p-3 italic text-gray-500 text-xs">${r ? r.note || '-' : ''}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        };

        // --- EKSPOR ---
        window.exportExcel = function() {
            const data = SISWA_DATA.map(s => {
                const r = appState.todayRecords[s.name];
                return { 
                    'Nama Siswa': s.name, 'Gender': s.gender, 
                    'Status': r ? r.status : 'Alpa', 
                    'Jam Absen': r ? r.time : '-',
                    'Keterangan Admin': r ? r.note : '-' 
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi");
            XLSX.writeFile(wb, `Laporan_BM_${getTodayKey()}.xlsx`);
        };

        window.exportPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Laporan Presensi SMK Bina Mandiri`, 105, 15, { align: 'center' });
            const rows = SISWA_DATA.map(s => {
                const r = appState.todayRecords[s.name];
                return [s.name, s.gender, r ? r.status : 'Alpa', r ? r.time : '-', r?.note || '-'];
            });
            doc.autoTable({ head: [['Nama', 'L/P', 'Status', 'Jam', 'Ket']], body: rows, startY: 25 });
            doc.save(`Laporan_BM_${getTodayKey()}.pdf`);
        };

    </script>
</body>
</html>